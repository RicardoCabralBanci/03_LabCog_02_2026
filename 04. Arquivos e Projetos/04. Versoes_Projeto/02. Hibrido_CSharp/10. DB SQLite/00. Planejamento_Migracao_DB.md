# 00. Planejamento de Migração: Excel para SQLite

**Autor**: Mestre em VBA (Persona 004)
**Data**: 19/12/2025
**Objetivo**: Eliminar a dependência do Excel (`Gerador_V4.xlsm`) como banco de dados, migrando a lógica de configuração e catálogo para um arquivo `manual_db.sqlite`.

---

## 1. Arquitetura do Banco de Dados (Schema)

O banco será normalizado para evitar a redundância que existe nas abas do Excel.

### 1.1 Tabelas Principais (Core)

#### `projects`
Armazena os metadados do projeto manual atual (o cabeçalho da "Planilha3").
*   `id` (INTEGER PK AUTOINCREMENT)
*   `sap_number` (TEXT UNIQUE) - Ex: "10356587"
*   `project_name` (TEXT) - Ex: "K-89409849 - FEMSA"
*   `revision` (TEXT) - Ex: "00"
*   `machine_type` (TEXT) - Ex: "DVD", "BTR", "GTR"
*   `created_at` (DATETIME DEFAULT CURRENT_TIMESTAMP)

#### `manual_sections` (Catálogo de Módulos)
Lista de todos os possíveis capítulos/arquivos `.docx` que podem compor um manual. Substitui a lista estática da "Planilha3" e as colunas de "Caminho".
*   `id` (INTEGER PK AUTOINCREMENT)
*   `machine_type` (TEXT) - FK lógica. Ex: "DVD", "GLOBAL" (se servir pra todos)
*   `section_name` (TEXT) - Ex: "Instruções de Segurança", "Manutenção do Manifold"
*   `file_path_template` (TEXT) - Caminho relativo ou absoluto do `.docx`.
*   `default_order` (INTEGER) - Ordem padrão de inserção.
*   `description` (TEXT) - O que é este módulo.

### 1.2 Tabelas de Configuração (Features)

#### `project_composition` (A "Lista de Reprodução")
A tabela que substitui o "Yes/No" da Planilha3. Relaciona Projetos com Seções.
*   `id` (INTEGER PK AUTOINCREMENT)
*   `project_id` (INTEGER FK -> projects.id)
*   `section_id` (INTEGER FK -> manual_sections.id)
*   `is_active` (BOOLEAN) - Se 1, o arquivo é mesclado. Se 0, é ignorado.
*   `custom_order` (INTEGER) - Caso este projeto precise de uma ordem diferente da padrão.

### 1.3 Tabelas de Dados Técnicos (Substituindo Abas "DVD Dados", "CIP Químicos")

#### `technical_parameters`
Definição dos parâmetros possíveis (Meta-dados).
*   `id` (INTEGER PK AUTOINCREMENT)
*   `machine_type` (TEXT) - Ex: "DVD"
*   `category` (TEXT) - Ex: "Dados do Sistema", "Botoeiras"
*   `param_key` (TEXT) - Ex: "velocidade_nominal", "volume_tanque"
*   `unit` (TEXT) - Ex: "mm", "L/h"
*   `description` (TEXT)

#### `project_values`
Os valores reais para um projeto específico.
*   `id` (INTEGER PK AUTOINCREMENT)
*   `project_id` (INTEGER FK -> projects.id)
*   `param_id` (INTEGER FK -> technical_parameters.id)
*   `value` (TEXT) - O valor inserido (Ex: "3534", "P100").

---

## 2. Estratégia de Migração (Script Python)

Criaremos um script `migrate_legacy.py` que fará a "raspagem" do Excel uma única vez.

1.  **Conexão**: Usa `pandas` para ler o Excel `Gerador_V4.xlsm`.
2.  **Parsing de "Dados Salvos"**:
    *   Itera as linhas 5-138.
    *   Cria entradas na tabela `manual_sections` com os caminhos encontrados.
    *   Cria um projeto "Default_Legacy" na tabela `projects`.
    *   Popula `project_composition` com os "Yes/No" atuais como estado inicial.
3.  **Parsing de Abas Técnicas**:
    *   Lê abas como `DVD Dados do sistema`.
    *   Identifica pares Chave-Valor.
    *   Popula `technical_parameters` e `project_values`.

---

## 3. Fluxo de Uso Futuro (CLI)

O usuário não editará mais o Excel.
1.  **Novo Projeto**: `cli create-project --sap 12345 --type DVD` -> Cria entrada no DB.
2.  **Editar Config**: `cli config --project 12345 --enable-section "Manifold"` -> Atualiza `project_composition`.
3.  **Gerar Manual**: O script Python lê `project_composition` (WHERE project_id=... AND is_active=1), pega os caminhos em `manual_sections` e executa o merge.

---

## 4. Próximos Passos
1.  Criar script DDL (`schema.sql`) para gerar o banco vazio.
2.  Criar script de migração (`migrate.py`) para popular com dados do Excel.
3.  Validar se os dados no SQLite batem com o Excel.
