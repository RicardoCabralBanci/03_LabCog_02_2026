# Cache Cognitivo - Autópsia 2026-01-27
## Título: Transplante de Tabelas Dinâmicas (Solução "Frankenstein" para NewEngine)

### PROBLEMA
A NewEngine (C#) não exibia dados de tabelas auxiliares (Componentes Integrados, Áreas, etc.) porque:
1.  O **VBA Legado** usava automação OLE (Copy/Paste) para inserir tabelas do Excel diretamente no Word.
2.  A **Ponte VBA (V8)** só enviava a lista de arquivos para o C# via CSV, ignorando os dados das outras abas do Excel.
3.  A **Engine C# (V3.0)** usava `AltChunk` para juntar documentos, o que impedia a edição "pós-processamento" (o conteúdo dos anexos não é "real" até o Word abrir o arquivo). Tentar editar um `AltChunk` resultou em corrupção de layout.

### SOLUÇÃO ARQUITETURAL (VBA V9 + C# V3.1)

A solução foi um **Pré-Processamento Híbrido**:

#### 1. VBA V9 (`mod_NewEngine_V9_Tables.md`)
- **Extração Inteligente**: O VBA agora varre as planilhas de dados (`Planilha4`, `Planilha7`, etc.) **antes** de chamar a Engine.
- **Pular Cabeçalhos**: A extração começa na linha correta (ex: linha 3 ou 4) para evitar que os títulos do Excel sejam enviados como dados.
- **Serialização**: Os dados da tabela são convertidos em linhas de texto no manifesto `input_manifest.csv` usando o formato: `TABLE_ROW;Nome Da Tabela;Coluna1;Coluna2;Coluna3...`
- **Tolerância a Falhas**: A função `ExtractTableData` agora é "blindada" com `On Error Resume Next`, permitindo que a geração prossiga mesmo que uma das planilhas de dados esteja faltando.

#### 2. C# Engine V3.1 (`NewEngine_V3.1_Source.md`)
- **Parser de Tabelas**: O `ParseManifest` foi atualizado para reconhecer e carregar as linhas `TABLE_ROW` em um `Dictionary<string, List<string[]>>` na memória.
- **Pré-Processamento**: A Engine agora executa uma etapa `PreProcessFiles` **antes** de juntar os documentos.
    - O motor itera sobre a lista de arquivos de entrada.
    - Para cada arquivo, ele cria uma **cópia temporária**.
    - Ele abre essa cópia, procura por tabelas com **Alt Text (Título)** que correspondam aos dados carregados.
    - **Se encontrar**, ele executa a cirurgia `FillTable` nesse arquivo temporário.
- **Cirurgia de Tabela (`FillTable`)**:
    - **Limpeza**: Remove todas as linhas de dados existentes, preservando a(s) linha(s) de cabeçalho.
    - **Molde de Estilo**: Usa a primeira linha de dados do template como molde para a formatação das novas linhas.
    - **Ajuste Dinâmico de Colunas**: O código remove células excedentes se os dados do CSV tiverem menos colunas que a tabela do Word, garantindo consistência visual.
- **Restauração de Layout**: A lógica da V2.1 de isolamento de seção da Capa e aplicação do `manual.dotm` foi **reintegrada**, consertando a "destruição de formatação".
- **Junção Segura**: O motor então usa o `AltChunk` para juntar os arquivos **já pré-processados** (os temporários, se foram modificados, ou os originais).

### CONCLUSÃO
A abordagem de pré-processamento resolve o conflito com `AltChunk` e garante que a formatação do documento seja preservada. A responsabilidade fica dividida: VBA extrai, C# edita os pedaços e depois monta o quebra-cabeça.

---
*Assinado: O Mestre em VBA (para que meu eu de amanhã não seja um idiota).*
