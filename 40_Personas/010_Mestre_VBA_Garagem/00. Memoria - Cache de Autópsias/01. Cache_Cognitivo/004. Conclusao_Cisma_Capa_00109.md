# Conclusão de Autópsia: O Cisma da Capa (Dossiê 00109)

**Status:** RESOLVIDO
**Data:** 26/01/2026
**Especialista:** Mestre em VBA

## 1. O Diagnóstico do Conflito
O sistema estava sofrendo de uma "Crise de Identidade de Metadados". 
- O **Legado (Innopack)** buscava a propriedade `MachineModel`.
- O **Novo (Innopal)** buscava a propriedade `MachineType`.
- O **Motor C#** original era míope e só injetava em `MachineType`, ignorando a filtragem geográfica necessária se o nome fosse muito longo.

## 2. A Solução Arquitetural (Estratégia da Chave Mestra)
A solução exigiu uma intervenção em três frentes para garantir retrocompatibilidade e flexibilidade:

### A. A Ponte VBA (V8)
O código VBA foi alterado para enviar **duas chaves distintas** no CSV:
1. `MACHINE_TYPE`: Contém apenas o código curto (ex: "PLT", "BTR"). **Finalidade:** Lógica interna de filtro de arquivos no C#.
2. `MACHINE_NAME_FULL`: Captura o valor real de `Info.Maquina.Value` (ex: "Innopal PB 1/2"). **Finalidade:** Exibição visual na capa.

### B. O Motor C# (Program.cs)
O método `InjectMetadata` foi atualizado para:
- Detectar a presença de `MACHINE_NAME_FULL`.
- Realizar a **Dupla Injeção**: O valor completo é escrito simultaneamente em `MachineType` e `MachineModel`.
- Isso garante que qualquer template (velho ou novo) encontre seu dado.

### C. Padronização de Templates
Recomendado que novos templates utilizem `MachineModel` para alinhar com o padrão histórico, mas o sistema agora suporta ambos via `MachineType`.

## 3. Localização dos Artefatos
- **VBA:** `40_Personas/040. Mestre em VBA (A Garagem de Autópsias Digitais)/03. Projetos/00. Gerador_Automatico_Manuais/06. Ajuste_Capa_Manual/Proposta_VBA_Bridge_V8.md`
- **C# (Fonte):** `25. Scripts/NewEngine/src/csharp/Program.cs`
- **C# (Executável):** `25. Scripts/NewEngine/src/csharp/bin/Release/net10.0/win-x64/publish/NewGeradorV2.exe`

---
**Nota para o próximo "Eu":** Não tente unificar as chaves no CSV. A separação entre *Código de Filtro* e *Nome de Exibição* é o que mantém esse castelo de cartas em pé.
