# Mecanismo de Injeção da Capa (VBA Legado)

**Origem**: `[[0700. Script_GTR.md]]`
**Localização Original**: `40_Personas\040. Mestre em VBA (A Garagem de Autópsias Digitais)\03. Projetos\00. Gerador_Automatico_Manuais\00. Legado\0700. Script_GTR.md`

## 1. O Diagnóstico
Ao contrário do que se poderia pensar, o VBA **não desenha** a capa. Ele a trata como um documento Word comum (`.docx`) que é inserido no início do Manual Mestre. A "mágica" acontece via **Custom Document Properties**.

O VBA injeta valores (Número do Projeto, Revisão, Ano, etc.) em variáveis ocultas do documento Word. O Word, por sua vez, tem campos (`{Fields}`) posicionados na Capa que exibem esses valores.

## 2. O Código da Infecção
Abaixo estão as subrotinas responsáveis por essa injeção de dados.

### 2.1. O Maestro (`UpdateCustomProperties`)
Define *quais* dados serão injetados. Note que ele busca valores de um objeto/Formulário chamado `Info` (ex: `Info.SapNr.Value`).

```vba
Private Sub UpdateCustomProperties(ByRef objDoc As Word.Document)
    
    ' Define o Tipo da Máquina (Hardcoded no GTR, mas dinâmico nos outros?)
    UpdateCDP "MachineType", objDoc, "GTR"
    
    ' Puxa dados do Form 'Info' (SapNr, Projeto, Revisao, Ano)
    UpdateCDP "MachineNumber", objDoc, Info.SapNr.Value
    UpdateCDP "Order", objDoc, Info.Projeto.Value
    UpdateCDP "Revision", objDoc, Info.Revisao.Value
    UpdateCDP "MachineYear", objDoc, Info.Ano.Value
End Sub
```

### 2.2. O Executor (`UpdateCDP`)
Tenta escrever o valor na propriedade. Se a propriedade não existir no documento Word, ele silencia e ignora (graças à verificação `CDPExists`).

```vba
Private Sub UpdateCDP(ByVal CDPName As String, ByRef objDoc As Word.Document, ByVal Value As String)

    If Not CDPExists(CDPName, objDoc) Then Exit Sub

    objDoc.CustomDocumentProperties(CDPName) = Value

End Sub
```

### 2.3. O Verificador (`CDPExists`)
Verifica se o documento Word alvo possui a propriedade customizada criada. Se o `.docx` da Capa não tiver a propriedade "MachineNumber" criada previamente, o código acima falha silenciosamente.

```vba
Private Function CDPExists(ByVal CDPName As String, ByRef objDoc As Word.Document) As Boolean
    Dim objCDP As Variant
    For Each objCDP In objDoc.CustomDocumentProperties
        If objCDP.Name = CDPName Then
            CDPExists = True
            Exit Function
        End If
    Next
    
    CDPExists = False
End Function
```

## 3. A Solução Cirúrgica em C# (Conceitual)

Para a nova Engine, abandonaremos a automação lenta via OLE/Interop (que abre o Word visualmente) e adotaremos a manipulação direta de XML via **OpenXML SDK**. Isso permite alterar o arquivo em milissegundos, sem necessidade de ter o Office instalado no servidor.

### O Algoritmo de "Injeção Genética"

A solução deve seguir estritamente este fluxo lógico para garantir robustez:

1.  **Abertura Cirúrgica**:
    *   Carregar o arquivo `.docx` em memória como um pacote OpenXML (WordprocessingDocument).
    *   O acesso deve ser de Leitura/Escrita, mas sem travar o arquivo para outros processos se possível.

2.  **Localização do Órgão (CustomFilePropertiesPart)**:
    *   Navegar até a partição do documento responsável por `CustomProperties`.
    *   **Correção de Falha do Legado**: Diferente do VBA, se essa partição não existir (o documento nunca teve propriedades antes), o código deve **criá-la** imediatamente, em vez de falhar silenciosamente.

3.  **Processo de Upsert (Update ou Insert)**:
    *   Para cada dado (SapNr, Projeto, Revisão):
        *   Verificar se a propriedade já existe pelo Nome.
        *   **Se existir**: Atualizar o valor texto.
        *   **Se não existir**: Criar uma nova propriedade, atribuir um ID único e o valor.
    *   *Nota*: Isso resolve o problema de templates "virgens" que quebravam o script antigo.

4.  **O Pulo do Gato (UpdateFieldsOnOpen)**:
    *   Apenas injetar os dados não atualiza a visualização na Capa imediatamente.
    *   Devemos acessar a partição `DocumentSettingsPart`.
    *   Inserir ou definir a flag `<w:updateFields val="true"/>`.
    *   **Resultado**: Quando o usuário abrir o manual pela primeira vez, o Word detectará essa flag e forçará uma atualização automática de todos os campos `{Fields}`, preenchendo a capa corretamente sem intervenção humana.

### Vantagens desta Abordagem
*   **Performance**: Processamento instantâneo (não carrega a GUI do Word).
*   **Estabilidade**: Elimina erros de RPC e processos "zumbis" do Word (WINWORD.EXE) travados na memória.
*   **Autonomia**: O arquivo resultante é autocontido e já nasce com a instrução de se atualizar.


