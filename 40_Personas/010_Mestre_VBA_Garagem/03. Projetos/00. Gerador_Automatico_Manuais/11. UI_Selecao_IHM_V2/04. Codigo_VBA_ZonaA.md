# Código VBA: Motor de UI V2.4 (Fix de Cor e Sintaxe)

**Status**: Versão 2.4 (Geometry Control)
**Notas**: Botões com altura de 2 células. Controle de largura por margem. Agrupamento de Cards.

---

## Módulo: `mod_UI_Core`

```vba
Attribute VB_Name = "mod_UI_Core"
Option Explicit

' ==============================================================================
' ARQUITETURA DE UI - VERSÃO 2.4
' ==============================================================================

' --- CONSTANTES DE GEOMETRIA ---
Private Const COL_SIDEBAR As String = "A"
Private Const COL_GUTTER As String = "B"
Private Const COL_GALLERY_START As String = "C"

Private Const ROW_START_UI As Integer = 5     ' Início (Pula 1-3 Corp + 4 Título)
Private Const BTN_HEIGHT_CELLS As Integer = 2 ' Botão ocupa 2 linhas
Private Const BTN_GAP_CELLS As Integer = 1    ' Espaço entre botões (1 linha)
Private Const BTN_MARGIN_H As Double = 6      ' MARGEM DE LARGURA (Ajuste aqui!)

' --- PALETA DE CORES ---
Private Const CLR_SIDEBAR_BG As Long = 3618615   ' Cinza Chumbo
Private Const CLR_TEXT_WHITE As Long = 16777215
Private Const CLR_TEXT_GREY As Long = 8421504

Private Const CLR_BRAND_KHS As Long = 9863790    ' Clearline (Cinza Azulado)
Private Const CLR_BRAND_SIE As Long = 12411904   ' Siemens (Azul)
Private Const CLR_BRAND_ROC As Long = 46116      ' Rockwell (Laranja)

' --- ESTRUTURAS DE DADOS ---
Public Type T_IHM_Card
    ID As Long
    Fabricante As String
    Modelo As String
    Tamanho As String
    Engine As String
    ImgPath As String
End Type

Private Catalog() As T_IHM_Card
Private CatalogCount As Integer
Private IsCatalogLoaded As Boolean

' Estado dos Filtros
Public Filter_Clearline As Boolean
Public Filter_Siemens As Boolean
Public Filter_Rockwell As Boolean

' ==============================================================================
' 1. SETUP INICIAL
' ==============================================================================
Public Sub Init_UI()
    Dim ws As Worksheet
    Set ws = ActiveSheet
    
    Application.ScreenUpdating = False
    
    ' 1. Carrega Dados
    Load_Catalog_From_DB
    
    ' 2. Limpeza Radical e Grid
    On Error Resume Next
    ws.DrawingObjects.Delete
    ws.Cells.Interior.Color = xlNone
    ws.Rows.RowHeight = 15 ' Garante altura padrão em tudo
    On Error GoTo 0
    
    ' 3. Configuração de Colunas
    ws.Columns(COL_SIDEBAR).ColumnWidth = 25
    
    ' --- FIX: Pinta apenas da linha 4 para baixo ---
    ws.Range(ws.Cells(4, 1), ws.Cells(ws.Rows.Count, 1)).Interior.Color = CLR_SIDEBAR_BG
    
    ws.Columns(COL_GUTTER).ColumnWidth = 2
    
    ws.Columns("C:E").ColumnWidth = 15
    
    ' 4. Inicializa Filtros
    If Not Filter_Clearline And Not Filter_Siemens And Not Filter_Rockwell Then
        Filter_Clearline = True: Filter_Siemens = True: Filter_Rockwell = True
    End If
    
    ' 5. Renderiza
    Render_Sidebar
    Render_Gallery
    
    ws.Range("A1").Select
    Application.ScreenUpdating = True
End Sub

' ==============================================================================
' 2. MOTOR DE DADOS (PLANILHA66)
' ==============================================================================
Private Sub Load_Catalog_From_DB()
    Dim wsDB As Worksheet, lastRow As Long, i As Long
    On Error Resume Next
    Set wsDB = Planilha66
    If wsDB Is Nothing Then Set wsDB = ThisWorkbook.Sheets("ihm_models")
    On Error GoTo 0
    
    If wsDB Is Nothing Then MsgBox "Erro: Planilha ihm_models não encontrada.": Exit Sub
    
    lastRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row
    If lastRow < 2 Then Exit Sub
    
    CatalogCount = lastRow - 1
    ReDim Catalog(1 To CatalogCount)
    
    For i = 2 To lastRow
        With Catalog(i - 1)
            .ID = wsDB.Cells(i, 1).Value
            .Fabricante = wsDB.Cells(i, 3).Value
            .Modelo = wsDB.Cells(i, 4).Value
            .Tamanho = wsDB.Cells(i, 5).Value
            .Engine = wsDB.Cells(i, 6).Value
            .ImgPath = wsDB.Cells(i, 8).Value
        End With
    Next i
    IsCatalogLoaded = True
End Sub

' ==============================================================================
' 3. SIDEBAR (SNAP TO GRID)
' ==============================================================================
Private Sub Render_Sidebar()
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim currRow As Integer
    
    ' Título na Linha 4
    With ws.Cells(ROW_START_UI - 1, 1)
        .Value = "FILTROS"
        .Font.Color = CLR_TEXT_GREY: .Font.Bold = True: .HorizontalAlignment = xlCenter
        .Font.Size = 8
    End With
    
    currRow = ROW_START_UI
    
    ' Renderização dos Botões (Snap a cada 2 linhas + 1 de gap)
    Draw_Sidebar_Btn_Grid "btn_filter_khs", "CLEARLINE", currRow, Filter_Clearline, CLR_BRAND_KHS
    currRow = currRow + BTN_HEIGHT_CELLS + BTN_GAP_CELLS
    
    Draw_Sidebar_Btn_Grid "btn_filter_sie", "SIEMENS", currRow, Filter_Siemens, CLR_BRAND_SIE
    currRow = currRow + BTN_HEIGHT_CELLS + BTN_GAP_CELLS
    
    Draw_Sidebar_Btn_Grid "btn_filter_roc", "ROCKWELL", currRow, Filter_Rockwell, CLR_BRAND_ROC
End Sub

Private Sub Draw_Sidebar_Btn_Grid(id As String, label As String, startRow As Integer, isOn As Boolean, brandColor As Long)
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim rng As Range, btn As Shape
    
    ' Calcula o Range que o botão cobre (ex: A5:A6)
    Set rng = ws.Range(ws.Cells(startRow, 1), ws.Cells(startRow + BTN_HEIGHT_CELLS - 1, 1))
    
    ' Desenha usando as coordenadas do Range + Margem Variável
    Set btn = ws.Shapes.AddShape(msoShapeRoundedRectangle, _
        rng.Left + BTN_MARGIN_H, _
        rng.Top, _
        rng.Width - (BTN_MARGIN_H * 2), _
        rng.Height)
        
    With btn
        .Name = id
        .TextFrame.Characters.Text = label
        .TextFrame.Characters.Font.Bold = True: .TextFrame.Characters.Font.Size = 9
        .Line.Visible = msoFalse: .OnAction = "Toggle_Filter_Handler"
        
        If isOn Then
            .Fill.ForeColor.RGB = brandColor: .TextFrame.Characters.Font.Color = CLR_TEXT_WHITE
            .Shadow.Type = msoShadow25: .Shadow.Transparency = 0.7
        Else
            .Fill.ForeColor.RGB = RGB(60, 60, 60): .TextFrame.Characters.Font.Color = CLR_TEXT_GREY
            .Fill.Transparency = 0.6
        End If
    End With
End Sub

' ==============================================================================
' 4. GALERIA (GROUPED & REAL IMAGES)
' ==============================================================================
Public Sub Render_Gallery()
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim topPos As Double
    Dim i As Integer, showItem As Boolean
    
    If Not IsCatalogLoaded Then Load_Catalog_From_DB
    
    ' Limpeza de Grupos (Evita Fantasmas)
    Dim s As Shape
    For Each s In ws.Shapes
        If s.Name Like "grp_card_*" Then s.Delete
    Next s
    
    topPos = ws.Cells(ROW_START_UI, 3).Top
    
    For i = 1 To CatalogCount
        showItem = False
        Select Case UCase(Catalog(i).Fabricante)
            Case "CLEARLINE": If Filter_Clearline Then showItem = True
            Case "SIEMENS":   If Filter_Siemens Then showItem = True
            Case "ROCKWELL":  If Filter_Rockwell Then showItem = True
        End Select
        
        If showItem Then
            topPos = Draw_Rich_Card_Grouped(Catalog(i), topPos)
        End If
    Next i
End Sub

Private Function Draw_Rich_Card_Grouped(data As T_IHM_Card, topPos As Double) As Double
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim leftPos As Double: leftPos = ws.Range("C1").Left
    
    ' --- FIX: Declaração correta das variáveis ---
    Dim cardW As Double: cardW = 280
    Dim cardH As Double: cardH = 75
    
    ' Array para agrupar os nomes
    Dim shpNames() As String: Dim shpCount As Integer: shpCount = 0
    
    ' 1. Fundo
    Dim bg As Shape
    Set bg = ws.Shapes.AddShape(msoShapeRoundedRectangle, leftPos, topPos, cardW, cardH)
    bg.Name = "tmp_bg_" & data.ID: bg.Fill.ForeColor.RGB = CLR_TEXT_WHITE
    bg.Line.ForeColor.RGB = RGB(220, 220, 220): bg.Shadow.Type = msoShadow25
    AddShapeToArray bg.Name, shpNames, shpCount
    
    ' 2. Imagem (Tentativa Real)
    Dim img As Shape: Dim path As String
    path = ThisWorkbook.path & "\" & data.ImgPath
    If InStr(data.ImgPath, ":") > 0 Then path = data.ImgPath
    
    On Error Resume Next
    Set img = ws.Shapes.AddPicture(path, msoFalse, msoTrue, leftPos + 5, topPos + 5, 65, 65)
    If img Is Nothing Then
        Set img = ws.Shapes.AddShape(msoShapeRectangle, leftPos + 5, topPos + 5, 65, 65)
        img.Fill.ForeColor.RGB = RGB(245, 245, 245): img.TextFrame.Characters.Text = "IMG?"
        img.TextFrame.Characters.Font.Color = vbRed: img.TextFrame.Characters.Font.Size = 8
        img.Line.Visible = msoFalse
    End If
    On Error GoTo 0
    img.Name = "tmp_img_" & data.ID
    AddShapeToArray img.Name, shpNames, shpCount
    
    ' 3. Texto e Badges
    Dim txt As Shape
    Set txt = ws.Shapes.AddTextbox(msoTextOrientationHorizontal, leftPos + 75, topPos + 5, 200, 25)
    txt.Name = "tmp_txt_" & data.ID: txt.TextFrame.Characters.Text = data.Modelo
    txt.TextFrame.Characters.Font.Name = "Segoe UI": txt.TextFrame.Characters.Font.Bold = True
    txt.TextFrame.Characters.Font.Size = 11: txt.Fill.Visible = msoFalse: txt.Line.Visible = msoFalse
    AddShapeToArray txt.Name, shpNames, shpCount
    
    ' Badges
    Dim bColor As Long
    Select Case UCase(data.Fabricante)
        Case "SIEMENS": bColor = CLR_BRAND_SIE
        Case "CLEARLINE": bColor = CLR_BRAND_KHS
        Case "ROCKWELL": bColor = CLR_BRAND_ROC
        Case Else: bColor = CLR_TEXT_GREY
    End Select
    
    Dim b1 As Shape, b2 As Shape
    Set b1 = Create_Badge(leftPos + 75, topPos + 45, data.Engine, bColor, "tmp_b1_" & data.ID)
    AddShapeToArray b1.Name, shpNames, shpCount
    Set b2 = Create_Badge(leftPos + 135, topPos + 45, data.Tamanho, RGB(180, 180, 180), "tmp_b2_" & data.ID)
    AddShapeToArray b2.Name, shpNames, shpCount
    
    ' 4. Agrupar Tudo
    Dim grp As Shape
    Set grp = ws.Shapes.Range(shpNames).Group
    grp.Name = "grp_card_" & data.ID
    grp.OnAction = "Card_Click_Handler"
    
    Draw_Rich_Card_Grouped = topPos + cardH + 15
End Function

' --- FUNÇÕES AUXILIARES ---
Private Function Create_Badge(l As Double, t As Double, txt As String, color As Long, name As String) As Shape
    Dim w As Double: w = Len(txt) * 7 + 15
    Set Create_Badge = ActiveSheet.Shapes.AddShape(msoShapeRoundedRectangle, l, t, w, 18)
    With Create_Badge
        .Name = name: .Fill.ForeColor.RGB = color: .Line.Visible = msoFalse
        .TextFrame.Characters.Text = txt: .TextFrame.Characters.Font.Size = 8
        .TextFrame.Characters.Font.Color = vbWhite: .TextFrame.Characters.Font.Bold = True
    End With
End Function

Private Sub AddShapeToArray(name As String, arr() As String, ByRef count As Integer)
    count = count + 1: ReDim Preserve arr(1 To count): arr(count) = name
End Sub

Public Sub Toggle_Filter_Handler()
    Dim id As String: id = Application.Caller
    If id = "btn_filter_khs" Then Filter_Clearline = Not Filter_Clearline
    If id = "btn_filter_sie" Then Filter_Siemens = Not Filter_Siemens
    If id = "btn_filter_roc" Then Filter_Rockwell = Not Filter_Rockwell
    Render_Sidebar: Render_Gallery
End Sub

Public Sub Card_Click_Handler()
    MsgBox "ID: " & Replace(Application.Caller, "grp_card_", ""), vbInformation
End Sub
```