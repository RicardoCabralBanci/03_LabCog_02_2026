# Versão Candidata: mod_NewEngine_V9 (Suporte a Tabelas)
**Data**: 27/01/2026
**Novidades**: Implementação da função `ExtractTableData` para capturar tabelas de Componentes Integrados e outras configurações dinâmicas que o legado copiava via Clipboard.

```vba
Attribute VB_Name = "mod_NewEngine"
Option Explicit

' ==========================================================================================
' MÓDULO: mod_NewEngine_V9 (Ponte Geográfica - Versão Tabelas Dinâmicas)
' DESCRIÇÃO: Ponte entre Botões do Excel e Motor C# V2 + Metadados Capa + Tabelas Dinâmicas
' FUNCIONAMENTO: Recebe tipo máquina, metadados, tabelas de configuração, gera manifesto e chama EXE.
' AUTOR: Mestre em VBA (via Gemini CLI)
' DATA: 27/01/2026
' ==========================================================================================

Private Const TARGET_SHEET_NAME As String = "Base de Dados"
Private Const COL_PATH As String = "C"
Private Const COL_ACTIVE As String = "B"
Private Const START_ROW As Integer = 5

' --- PONTOS DE ENTRADA PARA OS BOTÕES ---
Sub Gerar_BTR(): Call ExportarParaNovoGerador("BTR"): End Sub
Sub Gerar_GTR(): Call ExportarParaNovoGerador("GTR"): End Sub
Sub Gerar_DVD(): Call ExportarParaNovoGerador("DVD"): End Sub
Sub Gerar_PET(): Call ExportarParaNovoGerador("PET"): End Sub
Sub Gerar_CIP(): Call ExportarParaNovoGerador("CIP"): End Sub
Sub Gerar_CMX(): Call ExportarParaNovoGerador("CMX"): End Sub
Sub Gerar_CCMX(): Call ExportarParaNovoGerador("CCMX"): End Sub
Sub Gerar_PLT(): Call ExportarParaNovoGerador("PLT"): End Sub
Sub Gerar_PCK(): Call ExportarParaNovoGerador("PCK"): End Sub

' --- MOTOR PRINCIPAL ---

Private Sub ExportarParaNovoGerador(machineType As String)
    Dim ws As Worksheet
    Dim lastRow As Long, i As Long
    Dim csvContent As String
    Dim fPath As String, fActive As String
    Dim csvPath As String, exePath As String
    Dim totalFiles As Integer
    Dim fso As Object
    
    ' Variáveis da Capa
    Dim valSapNr As String, valProjeto As String, valRevisao As String, valAno As String, valMaquinaFull As String
    
    On Error GoTo ErrorHandler
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Validação de Ambiente
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets(TARGET_SHEET_NAME)
    If ws Is Nothing Then Set ws = ThisWorkbook.Sheets("Dados Salvos")
    On Error GoTo ErrorHandler
    
    If ws Is Nothing Then
        MsgBox "ERRO: Aba 'Base de Dados' não encontrada.", vbCritical
        Exit Sub
    End If
    
    ' 2. Caminhos
    Dim baseDir As String: baseDir = ThisWorkbook.Path
    If fso.FolderExists(baseDir & "\NewGeradorV2") Then
        exePath = baseDir & "\NewGeradorV2\NewGeradorV2.exe"
        csvPath = baseDir & "\NewGeradorV2\input_manifest.csv"
    Else
        exePath = baseDir & "\NewGeradorV2.exe"
        csvPath = baseDir & "\input_manifest.csv"
    End If
    
    If Not fso.FileExists(exePath) Then
        MsgBox "ERRO CRÍTICO: Motor 'NewGeradorV2.exe' não encontrado.", vbCritical
        Exit Sub
    End If
    
    ' 3. Construção do Manifesto
    csvContent = "CATEGORY;KEY;VALUE;EXTRA1;EXTRA2" & vbCrLf
    csvContent = csvContent & "META;EXPORT_DATE;" & format(Now, "yyyy-mm-dd hh:mm:ss") & ";;" & vbCrLf
    csvContent = csvContent & "META;MACHINE_TYPE;" & machineType & ";;" & vbCrLf
    
    ' --- [DADOS DA CAPA] ---
    On Error Resume Next
    valSapNr = "N/A": valProjeto = "N/A": valRevisao = "0": valAno = Year(Now): valMaquinaFull = machineType
    If Not Info Is Nothing Then
        valSapNr = Info.SapNr.Value: valProjeto = Info.Projeto.Value
        valRevisao = Info.Revisao.Value: valAno = Info.Ano.Value: valMaquinaFull = Info.Maquina.Value
    End If
    On Error GoTo ErrorHandler
    
    csvContent = csvContent & "META;SAP_NUMBER;" & valSapNr & ";;" & vbCrLf
    csvContent = csvContent & "META;ORDER_NUMBER;" & valProjeto & ";;" & vbCrLf
    csvContent = csvContent & "META;REVISION;" & valRevisao & ";;" & vbCrLf
    csvContent = csvContent & "META;YEAR;" & valAno & ";;" & vbCrLf
    csvContent = csvContent & "META;MACHINE_NAME_FULL;" & valMaquinaFull & ";;" & vbCrLf
    
    ' --- [TABELAS DINÂMICAS - V9] ---
    ' Injeta os dados das tabelas auxiliares (Componentes, Áreas, etc.)
    csvContent = csvContent & ExtractTableData()
    
    ' --- [ARQUIVOS] ---
    lastRow = ws.Cells(ws.Rows.Count, COL_PATH).End(xlUp).Row
    If lastRow < START_ROW Then lastRow = START_ROW
    
    totalFiles = 0
    For i = START_ROW To lastRow
        fPath = Trim(ws.Range(COL_PATH & i).Value)
        fActive = UCase(Trim(ws.Range(COL_ACTIVE & i).Value))
        
        If (fActive = "YES" Or fActive = "TRUE" Or fActive = "SIM" Or fActive = "X" Or fActive = "1") And fPath <> "" Then
            ' Formato: FILE;ROW_INDEX;Caminho;;
            csvContent = csvContent & "FILE;" & i & ";" & Replace(fPath, ";", "_") & ";;" & vbCrLf
            totalFiles = totalFiles + 1
        End If
    Next i
    
    If totalFiles = 0 Then
        MsgBox "Aviso: Nenhum arquivo marcado com 'YES' encontrado.", vbExclamation
        Exit Sub
    End If
    
    ' 4. Salvar e Disparar
    Call SaveTextToFile(csvContent, csvPath)
    Shell """" & exePath & """ """ & csvPath & """", vbNormalFocus
    
    Exit Sub

ErrorHandler:
    MsgBox "Erro inesperado: " & Err.Description, vbCritical
End Sub

' --- FUNÇÕES AUXILIARES DE EXTRAÇÃO DE TABELAS (V9) ---

Private Function ExtractTableData() As String
    Dim sb As String
    sb = ""
    
    ' Mapeamento conforme análise do legado (Ajustado para pular Header na Linha 2):
    ' 1. Componentes integrados -> Planilha4 -> B3:D...
    sb = sb & ExtractSheetTable(Planilha4, "Componentes integrados", "B", "D", 3)
    
    ' 2. Áreas e segmentos -> Planilha8 -> B3:D...
    sb = sb & ExtractSheetTable(Planilha8, "Áreas e segmentos", "B", "D", 3)
    
    ' 3. Dispositivos de comando -> Planilha9 -> B4:D... (Header na 3)
    sb = sb & ExtractSheetTable(Planilha9, "Dispositivos de comando", "B", "D", 4)
    
    ' 4. Dispositivos de aviso -> Planilha10 -> B4:D... (Header na 3)
    sb = sb & ExtractSheetTable(Planilha10, "Dispositivos de aviso", "B", "D", 4)
    
    ' 5. Tipos de recipientes -> Planilha7 -> B3:H...
    sb = sb & ExtractSheetTable(Planilha7, "Tipos de recipientes", "B", "H", 3)
    
    ExtractTableData = sb
End Function

Private Function ExtractSheetTable(ws As Worksheet, tableName As String, colStart As String, colEnd As String, startRow As Integer) As String
    Dim lastRow As Long
    Dim r As Long, c As Integer
    Dim sb As String
    Dim lineContent As String
    Dim val As String
    Dim colStartNum As Integer, colEndNum As Integer
    
    On Error Resume Next ' Evita crash se planilha não existir
    If ws Is Nothing Then Exit Function
    
    ' Verifica se tem dados
    lastRow = ws.Cells(ws.Rows.Count, colStart).End(xlUp).Row
    If lastRow < startRow Then Exit Function
    
    colStartNum = ws.Range(colStart & "1").Column
    colEndNum = ws.Range(colEnd & "1").Column
    
    ' Varre a tabela linha por linha
    For r = startRow To lastRow
        lineContent = ""
        ' Monta a linha com as colunas
        For c = colStartNum To colEndNum
            val = ws.Cells(r, c).Value
            
            ' Limpeza básica para não quebrar o CSV (substitui ; por ,)
            If val <> "" Then
                val = Replace(val, ";", ",")
                val = Replace(val, vbCrLf, " ")
                val = Replace(val, vbCr, " ")
                val = Replace(val, vbLf, " ")
            Else
                val = "" ' Garante campo vazio se nulo
            End If
            
            lineContent = lineContent & val & ";"
        Next c
        
        ' Remove o último ponto e vírgula extra da linha
        If Len(lineContent) > 0 Then
            lineContent = Left(lineContent, Len(lineContent) - 1)
        End If
        
        ' Formato: TABLE_ROW;NomeTabela;Col1;Col2;Col3...
        sb = sb & "TABLE_ROW;" & tableName & ";" & lineContent & vbCrLf
    Next r
    
    ExtractSheetTable = sb
End Function

Private Sub SaveTextToFile(content As String, filePath As String)
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    With stream
        .Type = 2: .Charset = "utf-8": .Open
        .WriteText content
        .SaveToFile filePath, 2
        .Close
    End With
End Sub
```
