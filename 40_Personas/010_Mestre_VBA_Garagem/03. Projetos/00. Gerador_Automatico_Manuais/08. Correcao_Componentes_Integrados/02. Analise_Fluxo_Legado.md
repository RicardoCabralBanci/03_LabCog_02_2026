# Análise Forense: O Fluxo de Tabelas do Legado

**Status**: Identificado
**Script Fonte**: `Script_BTR.md` (Módulo `TableSub`)

## O Mecanismo "Frankenstein"
O sistema antigo utilizava automação OLE pesada para transferir tabelas visualmente do Excel para o Word, ignorando estruturas de dados formais.

### Passo 1: O Gatilho
Durante a geração do manual, o script `BTR` (ou similar) invoca a Sub `TableSub(objDoc, objword)`.
Esta rotina varre todas as tabelas do documento Word recém-criado em busca de marcadores específicos.

### Passo 2: Identificação via Alt Text
O código usa a propriedade `.Title` (Texto Alternativo) da tabela do Word como chave de identificação:
```vba
If oTable.Title = "Componentes integrados" Then
    ' ... lógica de cópia ...
End If
```

### Passo 3: Extração Direta (Copy)
Ao encontrar a tabela alvo, o VBA acessa diretamente uma planilha específica pelo seu Codename (ex: `Planilha4`) e copia um intervalo fixo para a área de transferência do Windows:
```vba
Set erng = Planilha4.Range("B2:D" & Planilha4.Range("B" & Rows.Count).End(xlUp).Row)
erng.Copy
```

### Passo 4: O "Limbo" (Documento Temporário)
O script cria um documento Word vazio e invisível para servir como área de trabalho intermediária.
```vba
Set oDoc = objword.Documents.Add
Set nRng = oDoc.Range
nRng.PasteExcelTable False, False, False ' Cola como tabela do Excel não-linkada
```

### Passo 5: Formatação Cirúrgica
Com a tabela no documento temporário, o script aplica formatação visual (bordas, larguras, fontes) linha por linha ou célula por célula, utilizando Subs auxiliares como `format` e `format2`.
```vba
Call format(ntable, objword)
Call format2(ntable, objword)
```

### Passo 6: Transplante Final
A tabela, agora formatada, é copiada novamente (`ntable.Range.Copy`).
No documento final (o manual), a tabela original (que serviu de marcador) é deletada e substituída pela nova versão:
```vba
Set oRng = oTable.Range
oTable.Delete
oRng.Paste
```

## Tabelas Envolvidas & Fontes
| Título no Word (Alt Text) | Fonte Excel (Codename) | Intervalo Típico |
| :--- | :--- | :--- |
| Componentes integrados | Planilha4 | B2:D (dinâmico) |
| Áreas e segmentos | Planilha8 | B2:D (dinâmico) |
| Dispositivos de comando | Planilha9 | B3:D (dinâmico) |
| Dispositivos de aviso | Planilha10 | B3:D (dinâmico) |
| Tipos de recipientes | Planilha7 | B2:H (dinâmico) |

## Conclusão da Autópsia
A migração para a NewEngine falhou neste ponto porque o processo dependia inteiramente da **interface gráfica** e da **área de transferência**, recursos que a nova engine (backend C#) não deve acessar. A solução exige converter essa transferência visual em uma transferência de dados estruturados (CSV).
