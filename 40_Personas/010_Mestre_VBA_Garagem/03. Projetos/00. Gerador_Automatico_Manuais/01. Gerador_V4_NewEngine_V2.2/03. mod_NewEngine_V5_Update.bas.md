```vba
Attribute VB_Name = "mod_NewEngine_V5"
Option Explicit

' ==========================================================================================
' MÓDULO: mod_NewEngine_V5 (Ponte Geográfica - VERSÃO 2.2)
' ATUALIZAÇÃO: Inclusão de suporte a PLT (Paletizador) e PCK (Encaixotadora)
' DESCRIÇÃO: Ponte entre Botões do Excel e Motor C# V2
' ==========================================================================================

Private Const TARGET_SHEET_NAME As String = "Base de Dados"
Private Const COL_PATH As String = "C"
Private Const COL_ACTIVE As String = "B"
Private Const START_ROW As Integer = 5

' --- PONTOS DE ENTRADA PARA OS BOTÕES (INTERFACE) ---

Sub Gerar_BTR()
    Call ExportarParaNovoGerador("BTR")
End Sub

Sub Gerar_GTR()
    Call ExportarParaNovoGerador("GTR")
End Sub

Sub Gerar_DVD()
    Call ExportarParaNovoGerador("DVD")
End Sub

Sub Gerar_PET()
    Call ExportarParaNovoGerador("PET")
End Sub

Sub Gerar_CIP()
    Call ExportarParaNovoGerador("CIP")
End Sub

Sub Gerar_CMX()
    Call ExportarParaNovoGerador("CMX")
End Sub

Sub Gerar_CCMX()
    Call ExportarParaNovoGerador("CCMX")
End Sub

' === NOVAS MÁQUINAS (V2.2) ===

Sub Gerar_PLT()
    Call ExportarParaNovoGerador("PLT")
End Sub

Sub Gerar_PCK()
    Call ExportarParaNovoGerador("PCK")
End Sub

' =============================


' --- MOTOR PRINCIPAL ---

Private Sub ExportarParaNovoGerador(machineType As String)
    Dim ws As Worksheet
    Dim lastRow As Long, i As Long
    Dim csvContent As String
    Dim fPath As String, fActive As String
    Dim csvPath As String, exePath As String
    Dim totalFiles As Integer
    Dim fso As Object
    
    On Error GoTo ErrorHandler
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Validação de Ambiente
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets(TARGET_SHEET_NAME)
    If ws Is Nothing Then
        Set ws = ThisWorkbook.Sheets("Dados Salvos") ' Fallback legado
    End If
    On Error GoTo ErrorHandler
    
    If ws Is Nothing Then
        MsgBox "ERRO CRÍTICO: Aba 'Base de Dados' não encontrada. O gerador precisa desta aba para mapear os arquivos.", vbCritical
        Exit Sub
    End If
    
    ' 2. Caminhos (Suporte a desenvolvimento e produção)
    Dim baseDir As String
    baseDir = ThisWorkbook.Path
    
    ' Lógica para encontrar o EXE:
    ' 1. Procura na subpasta NewGeradorV2 (Padrão de Dev)
    ' 2. Procura na pasta raiz (Padrão de Produção)
    If fso.FolderExists(baseDir & "\NewGeradorV2") Then
        exePath = baseDir & "\NewGeradorV2\NewGeradorV2.exe"
        csvPath = baseDir & "\NewGeradorV2\input_manifest.csv"
    Else
        exePath = baseDir & "\NewGeradorV2.exe"
        csvPath = baseDir & "\input_manifest.csv"
    End If
    
    If Not fso.FileExists(exePath) Then
        MsgBox "ERRO CRÍTICO DE ARQUITETURA:" & vbCrLf & _
               "O motor 'NewGeradorV2.exe' não foi encontrado." & vbCrLf & _
               "Local procurado: " & exePath, vbCritical
        Exit Sub
    End If
    
    ' 3. Construção do Manifesto
    ' O Gerador exporta TODOS os arquivos marcados com YES na Base de Dados.
    ' O filtro do que pertence a PLT vs CCMX é feito pelo C# baseando-se no MachineType e RowIndex.
    
    csvContent = "CATEGORY;KEY;VALUE" & vbCrLf
    csvContent = csvContent & "META;EXPORT_DATE;" & Format(Now, "yyyy-mm-dd hh:mm:ss") & vbCrLf
    csvContent = csvContent & "META;MACHINE_TYPE;" & machineType & vbCrLf
    
    lastRow = ws.Cells(ws.Rows.Count, COL_PATH).End(xlUp).Row
    If lastRow < START_ROW Then lastRow = START_ROW
    
    totalFiles = 0
    
    For i = START_ROW To lastRow
        fPath = Trim(ws.Range(COL_PATH & i).Value)
        fActive = UCase(Trim(ws.Range(COL_ACTIVE & i).Value))
        
        ' Verifica marcadores comuns de ativação
        If (fActive = "YES" Or fActive = "TRUE" Or fActive = "SIM" Or fActive = "X" Or fActive = "1") And fPath <> "" Then
            ' Formato: FILE;ROW_INDEX;Caminho
            csvContent = csvContent & "FILE;" & i & ";" & Replace(fPath, ";", "_") & vbCrLf
            totalFiles = totalFiles + 1
        End If
    Next i
    
    If totalFiles = 0 Then
        MsgBox "Aviso: Nenhum arquivo marcado com 'YES'/'X' foi encontrado na aba 'Base de Dados'." & vbCrLf & _
               "Certifique-se de que as seleções na IHM foram salvas na Base de Dados.", vbExclamation
        Exit Sub
    End If
    
    ' 4. Salvar e Disparar
    Call SaveTextToFile(csvContent, csvPath)
    
    Dim cmd As String
    ' Passa o caminho do CSV entre aspas para evitar erros com espaços
    cmd = """" & exePath & """ """ & csvPath & """"
    
    ' Executa sem travar a interface do Excel (vbNormalFocus)
    Shell cmd, vbNormalFocus
    
    Exit Sub

ErrorHandler:
    MsgBox "Erro inesperado na Engine V5: " & Err.Description, vbCritical
End Sub

Private Sub SaveTextToFile(content As String, filePath As String)
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    With stream
        .Type = 2 ' adTypeText
        .Charset = "utf-8"
        .Open
        .WriteText content
        .SaveToFile filePath, 2 ' adSaveCreateOverWrite
        .Close
    End With
End Sub
```