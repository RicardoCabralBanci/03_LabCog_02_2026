Attribute VB_Name = "mod_UI_ZoneB"
Option Explicit

' ==============================================================================
' RENDERIZADOR DA ZONA B (DETALHES & DOCUMENTOS)
' Versão: 1.1 (Estável - T_Card_Master)
' Dependências: mod_Shared_Definitions
' ==============================================================================

' Ponto de Entrada Principal
Public Sub Render_ZoneB(selectedIHM As T_Card_Master)
    Dim ws As Worksheet
    Set ws = ActiveSheet
    
    Application.ScreenUpdating = False
    
    ' 1. Limpeza da Zona B (G:H e J:L)
    Clear_ZoneB ws
    
    ' 2. Renderizar Painel de Hardware (G:H)
    Render_Hardware_Panel ws, selectedIHM
    
    ' 3. Renderizar Lista de Documentos (J:L)
    Render_Doc_List ws, selectedIHM.ID
    
    Application.ScreenUpdating = True
End Sub

Private Sub Clear_ZoneB(ws As Worksheet)
    Dim s As Shape
    ' Remove shapes antigos da Zona B (identificados pelo prefixo zB_)
    For Each s In ws.Shapes
        If s.Name Like "zB_*" Then
            s.Delete
        End If
    Next s
    
    ' Limpa textos e repinta o fundo
    With ws.Range("G5:H30")
        .ClearContents
        .Interior.Color = CLR_ZONE_BG
    End With
    
    With ws.Range("J5:L30")
        .ClearContents
        .Interior.Color = CLR_ZONE_BG
    End With
End Sub

' ------------------------------------------------------------------------------
' SUB-PAINEL ESQUERDO: HARDWARE (Datasheet)
' ------------------------------------------------------------------------------
Private Sub Render_Hardware_Panel(ws As Worksheet, data As T_Card_Master)
    Dim rngImg As Range
    Set rngImg = ws.Range("G5:H15")
    
    ' A. Imagem Ampliada
    Dim imgPath As String
    imgPath = data.ImgPath
    If imgPath = "" Or Dir(imgPath) = "" Then
        imgPath = ThisWorkbook.Path & "\Imagens\IHM_Generica.png"
    End If
    
    Dim shp As Shape
    On Error Resume Next
    Set shp = ws.Shapes.AddPicture(imgPath, msoFalse, msoTrue, _
              rngImg.Left + 5, rngImg.Top + 5, rngImg.Width - 10, rngImg.Height - 10)
    On Error GoTo 0
    
    If Not shp Is Nothing Then
        shp.Name = "zB_BigThumb"
        shp.Line.Visible = msoTrue
        shp.Line.ForeColor.RGB = CLR_TEXT_GREY
        shp.Line.Weight = 1
    End If
    
    ' B. Textos Descritivos
    With ws.Cells(16, 7)
        .Value = UCase(data.Modelo) & " (" & data.Engine & ")"
        .Font.Name = "Segoe UI"
        .Font.Bold = True
        .Font.Size = 11
        .Font.Color = CLR_TEXT_DARK
        .HorizontalAlignment = xlLeft
    End With
    
    With ws.Cells(17, 7)
        .Value = "Ref: " & data.Fabricante & " | Size: " & data.Tamanho
        .Font.Name = "Segoe UI"
        .Font.Size = 9
        .Font.Color = CLR_TEXT_GREY
        .HorizontalAlignment = xlLeft
    End With
    
    With ws.Cells(18, 7)
        .Value = "Status: " & data.Status
        .Font.Name = "Segoe UI"
        .Font.Bold = True
        .Font.Size = 9
        If UCase(data.Status) = "ATIVO" Then
            .Font.Color = CLR_STATUS_OK
        Else
            .Font.Color = CLR_STATUS_ERR
        End If
        .HorizontalAlignment = xlLeft
    End With
    
    ' C. Descrição Visual
    If data.Descricao <> "" Then
        With ws.Range("G20:H25")
            .Merge
            .Value = data.Descricao
            .VerticalAlignment = xlTop
            .HorizontalAlignment = xlLeft
            .WrapText = True
            .Font.Name = "Segoe UI"
            .Font.Size = 8
            .Font.Color = CLR_TEXT_GREY
        End With
    End If
End Sub

' ------------------------------------------------------------------------------
' SUB-PAINEL DIREITO: DOCUMENTOS (Lista de Capítulos)
' ------------------------------------------------------------------------------
Private Sub Render_Doc_List(ws As Worksheet, ihmID As Long)
    Dim docs() As T_Doc_Item
    Dim docCount As Integer
    Dim i As Integer, currRow As Integer
    
    docCount = Mock_Fetch_Docs(ihmID, docs)
    
    If docCount = 0 Then
        With ws.Cells(5, 10)
            .Value = "Nenhum documento mapeado."
            .Font.Color = CLR_TEXT_GREY
            .Font.Italic = True
        End With
        Exit Sub
    End If
    
    currRow = 5
    For i = 1 To docCount
        Draw_Doc_Item ws, docs(i), currRow
        
        ' LINHA DIVISÓRIA: Agora desenha para TODOS os itens (incluindo o último)
        Draw_Separator_Line ws, currRow + 2
        
        currRow = currRow + 3
    Next i
End Sub

Private Sub Draw_Separator_Line(ws As Worksheet, r As Integer)
    Dim lineShp As Shape
    Dim xStart As Single, xEnd As Single, yPos As Single
    
    ' Coordenadas: Do inicio da J até o fim da L
    xStart = ws.Cells(r, 10).Left
    xEnd = ws.Cells(r, 12).Left + ws.Cells(r, 12).Width
    yPos = ws.Cells(r, 10).Top ' Linha no topo da célula de intervalo
    
    Set lineShp = ws.Shapes.AddLine(xStart, yPos, xEnd, yPos)
    With lineShp
        .Name = "zB_Sep_" & r
        .Line.ForeColor.RGB = RGB(100, 100, 100) ' Cinza Escuro Sólido
        .Line.Weight = 1
        .Line.Transparency = 0 ' Sem transparência
    End With
End Sub

Private Sub Draw_Doc_Item(ws As Worksheet, item As T_Doc_Item, r As Integer)
    With ws.Cells(r, 10)
        .Value = item.Capitulo
        .Font.Name = "Segoe UI"
        .Font.Bold = True
        .Font.Size = 9
        .Font.Color = CLR_TEXT_DARK
        .HorizontalAlignment = xlLeft
    End With
    
    Dim ico As Shape
    Dim iconColor As Long
    If item.Existe Then
        iconColor = CLR_ICON_WORD
    Else
        iconColor = CLR_STATUS_ERR
    End If
    
    Set ico = ws.Shapes.AddShape(msoShapeFlowchartDocument, _
              ws.Cells(r, 11).Left + 5, ws.Cells(r, 11).Top, 15, 18)
    With ico
        .Name = "zB_DocIcon_" & r
        .Fill.ForeColor.RGB = iconColor
        .Line.Visible = msoFalse
    End With
    
    With ws.Cells(r + 1, 10)
        If item.Existe Then
            .Value = item.NomeArquivo
            .Font.Color = CLR_TEXT_GREY
        Else
            .Value = "[AUSENTE] " & item.NomeArquivo
            .Font.Color = CLR_STATUS_ERR
        End If
        .Font.Name = "Consolas"
        .Font.Size = 8
        .HorizontalAlignment = xlLeft
    End With
End Sub

Private Function Mock_Fetch_Docs(ihmID As Long, ByRef arr() As T_Doc_Item) As Integer
    ReDim arr(1 To 4)
    Dim basePath As String
    basePath = ThisWorkbook.Path & "\Imagens\templates\v3\"
    
    Dim pref As String
    If ihmID = 1 Then 
        pref = "CL30_" 
    ElseIf ihmID = 2 Then 
        pref = "SIE_TP_" 
    Else 
        pref = "PV_PLUS_"
    End If
    
    arr(1).Capitulo = "01. Interface": arr(1).NomeArquivo = pref & "Interface.docx"
    arr(2).Capitulo = "02. Modos": arr(2).NomeArquivo = pref & "Modos.docx"
    arr(3).Capitulo = "03. Operação": arr(3).NomeArquivo = pref & "Producao.docx"
    arr(4).Capitulo = "04. Falhas": arr(4).NomeArquivo = pref & "Falhas.docx"
    
    Dim i As Integer
    For i = 1 To 4
        arr(i).PathCompleto = basePath & arr(i).NomeArquivo
        arr(i).Existe = (Dir(arr(i).PathCompleto) <> "")
    Next i
    
    Mock_Fetch_Docs = 4
End Function
