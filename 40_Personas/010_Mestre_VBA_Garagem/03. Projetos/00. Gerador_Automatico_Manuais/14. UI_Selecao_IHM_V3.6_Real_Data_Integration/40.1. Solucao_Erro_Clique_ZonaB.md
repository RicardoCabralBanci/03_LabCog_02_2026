# Relatório de Correção: O Bug do "Clique Fantasma" (Erro 13)

**Data**: 03/02/2026
**Módulo Afetado**: `mod_UI_ZoneA`
**Função**: `Card_Click_Handler`
**Status**: Resolvido (Definitivo)

---

## 1. O Sintoma
Ao clicar em um Card da Galeria de IHMs, o Excel retornava o **Erro em Tempo de Execução 13: Tipos Incompatíveis**.

*   **Comportamento Esperado**: O clique no card (agrupado) deveria retornar o nome do grupo (`grp_card_8`).
*   **Comportamento Real**: O Excel propagava o evento do elemento *filho* clicado.
    *   Se clicou no texto: retornava `tmp_txt_8`.
    *   Se clicou na imagem: retornava `tmp_img_8`.
    *   Se clicou no fundo: retornava `tmp_bg_8`.

## 2. A Causa Raiz (Diagnóstico)
A lógica de extração do ID dependia de uma substituição de string rígida e ingênua:

```vba
' CÓDIGO ANTIGO (FRÁGIL)
' Assumia que o nome SEMPRE começava com "grp_card_"
strID = Replace(Application.Caller, "grp_card_", "") 

' Se o caller fosse "tmp_txt_8":
' Resultado: "tmp_txt_8" (pois não achou "grp_card_" para substituir)
' Consequência: CLng("tmp_txt_8") -> ERRO 13
```

O código sofria de "Excesso de Confiança na Hierarquia de Objetos". No VBA, `Application.Caller` é um delator: ele entrega o objeto exato que recebeu o foco, ignorando o agrupamento visual.

## 3. A Solução (Universal Parsing)
Abandonamos a tentativa de adivinhar o prefixo (`grp_`, `tmp_`, etc.). Adotamos a lógica de **Sufixo Mandatório**.

Como todos os elementos do card terminam em `_ID` (ex: `_8`), usamos a função `Split` para quebrar o nome no caractere sublinhado (`_`) e pegar sempre o último pedaço.

### O Novo Algoritmo:
1.  **Captura**: Recebe o nome de quem chamou (não importa quem seja).
2.  **Split**: Transforma `tmp_txt_8` em um array: `["tmp", "txt", "8"]`.
3.  **Extração**: Pega o último item do array (`UBound`).
4.  **Validação**: Verifica se é número (`IsNumeric`) antes de converter.

## 4. O Código Final (Blindado)

```vba
Public Sub Card_Click_Handler()
    Dim cardID As Long
    Dim shpName As String
    Dim strID As String
    Dim nameParts() As String
    
    ' 1. Captura quem chamou (texto, imagem, fundo ou grupo)
    shpName = Application.Caller
    
    ' 2. Parsing Inteligente
    ' Divide o nome por "_" e pega o último segmento
    nameParts = Split(shpName, "_")
    strID = nameParts(UBound(nameParts))
    
    ' 3. Validação Numérica (A vacina contra Erro 13)
    If Not IsNumeric(strID) Then
        MsgBox "Erro Fatal: ID não numérico detectado." & vbCrLf & _
               "Elemento: " & shpName, vbCritical
        Exit Sub
    End If
    
    cardID = CLng(strID)
    
    ' ... Resto da lógica de busca e renderização ...
End Sub
```

## 5. Lições Aprendidas
*   Nunca confie que o usuário vai clicar onde você quer.
*   Nunca confie no `Application.Caller` para respeitar grupos (`Shapes.Group`).
*   Sempre valide dados (`IsNumeric`) antes de forçar conversão de tipos (`CLng`).
