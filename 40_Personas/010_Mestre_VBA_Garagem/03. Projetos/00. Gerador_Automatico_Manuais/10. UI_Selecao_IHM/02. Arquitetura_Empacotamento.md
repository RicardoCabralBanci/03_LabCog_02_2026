# Arquitetura de Empacotamento: O Desafio do "Arquivo Único"

**Status**: Rascunho  
**Autor**: Mestre em VBA  
**Objetivo**: Avaliar métodos para unir UI Moderna (C#), Lógica de Negócio, Excel e Dados em um entregável monolítico ou transparente.

---

## 1. O Sonho: "Excel com Superpoderes"
O usuário abre um arquivo Excel e vê uma interface moderna, sem saber que existe um motor C# e um banco de dados por trás.

## 2. As Opções Técnicas

### Opção A: VSTO Add-in (Visual Studio Tools for Office) - **A Profissional**
*   **Como funciona**: Você cria um instalador (`setup.exe`). O usuário instala uma vez. A partir daí, *toda vez* que ele abrir o Excel, aparece uma aba nova "LabCogKHS" na Ribbon.
*   **Onde fica o C#**: Compilado em DLLs instaladas no `Program Files` ou `AppData`.
*   **Onde fica o DB**: Pode ser um arquivo SQLite na pasta de dados do usuário (`AppData`) ou um DB embutido.
*   **Prós**: 
    *   UI nativa do Excel (Custom Task Panes).
    *   Performance máxima.
    *   Atualizações fáceis (ClickOnce).
*   **Contras**: Exige instalação (admin rights às vezes). Não é "portátil" (não dá para levar num pen-drive e rodar sem instalar).

### Opção B: Excel-DNA - **A Hacker Elegante** (Recomendada)
*   **Como funciona**: Uma biblioteca open-source que permite criar Add-ins (.xll) usando C# sem a dor de cabeça do VSTO.
*   **O Truque do Empacotamento**: O Excel-DNA tem uma ferramenta (`ExcelDna.AddIn.Packed`) que compacta seu código C#, suas dependências e recursos num único arquivo `.xll`.
*   **A Experiência**: O usuário abre o `.xll` (que se comporta como um Excel) e *bum*, a aba aparece. Sem instalação.
*   **Banco de Dados**: Podemos embutir o SQLite como um "Recurso" (Resource) dentro do executável e extraí-lo para uma pasta temporária em tempo de execução.

### Opção C: O "Cavalo de Troia" (Embedding via VBA) - **A Magia Negra**
*   **Como funciona**:
    1. Você tem um arquivo `.xlsm` (Excel com Macro).
    2. O binário do seu executável C# (e do DB) é convertido em texto (Base64) e salvo dentro de uma aba oculta ou módulo do Excel.
    3. Quando o Excel abre (evento `Workbook_Open`), o VBA "vomita" esse texto num arquivo temporário, converte de volta para `.exe` e roda.
*   **Prós**: É literalmente um arquivo Excel único.
*   **Contras**: 
    *   Antivírus ODEIAM isso (comportamento de vírus).
    *   Lento na inicialização.
    *   Manutenção infernal (tem que re-codificar o Base64 a cada update).

---

## 3. Veredito: Excel-DNA ou VSTO

Para um ambiente corporativo profissional:

1.  **Se você pode instalar coisas na máquina do usuário**: **VSTO**. É o padrão Microsoft. Seguro, estável, integrado.
2.  **Se precisa ser "Portable" (sem install)**: **Excel-DNA**. Gera um arquivo `.xll` que contém tudo.

### Sobre o Banco de Dados (SQLite) no Arquivo Único
Independente de escolher VSTO ou Excel-DNA, o banco de dados (arquivo `.db`) não pode ser "lido" de dentro do executável. O SQLite precisa de um arquivo físico no disco.
*   **Solução**: O C# deve ter o arquivo `.db` embutido como **Embedded Resource**. Na inicialização, ele verifica: "O arquivo `C:\Users\...\AppData\Local\LabCogKHS\data.db` existe?". Se não, ele extrai o recurso para lá.
*   **Resultado**: Para o usuário, é transparente. Ele nunca vê o arquivo do banco.

---

## 4. Recomendação para o LabCogKHS

Vamos de **VSTO** ou **Excel-DNA**?
Considerando que queremos UI moderna (WPF) sobre o Excel:

**Recomendo VSTO** se quisermos criar uma **Ribbon fixa** permanente na máquina do desenvolvedor.
**Recomendo Executável Externo (Launcher)** se a ideia é só uma ferramenta auxiliar que abre quando precisa, sem modificar o Excel do usuário permanentemente.

*Add-ins modificam o Excel do usuário para sempre. Launchers só existem enquanto estão rodando.*
