# Código VBA Final (Versão 3.3 - Flat UI & Clean Toggle)

**Instruções de Uso**:
1. Copie todo o bloco de código abaixo.
2. Cole em um Módulo VBA (Substitua qualquer versão anterior).
3. Certifique-se de ter as planilhas `ihm_models` e `module_mapping` (ou ajuste no código).

```vba
Attribute VB_Name = "mod_UI_Core_v33"
Option Explicit

' ==============================================================================
' ARQUITETURA DE UI - VERSÃO 3.3 (FLAT DESIGN & GHOST KILLER)
' ==============================================================================

' --- GEOMETRIA ---
Private Const COL_SIDEBAR As String = "A"
Private Const ROW_START_UI As Integer = 5
Private Const BTN_HEIGHT_CELLS As Integer = 2
Private Const BTN_MARGIN_H As Double = 2
Private Const CARD_HEIGHT_CELLS As Integer = 4

' --- CORES (CINZAS NEUTROS REAIS) ---
Private Const CLR_SIDEBAR_BG As Long = 2960685   ' RGB(45,45,45) - Cinza Carvão
Private Const CLR_HEADER_BG As Long = 3947580    ' RGB(60,60,60) - Cinza Grafite
Private Const CLR_BTN_ACTIVE As Long = 5263440   ' RGB(80,80,80) - Cinza Médio (ON)
Private Const CLR_BTN_INACTIVE As Long = 13816530 ' RGB(210,210,210) - Cinza Claro (OFF)
Private Const CLR_CARD_BG As Long = 16119285     ' RGB(245,245,245) - Quase Branco
Private Const CLR_TEXT_WHITE As Long = 16777215
Private Const CLR_TEXT_DARK As Long = 3289650    ' RGB(50,50,50)
Private Const CLR_TEXT_GREY As Long = 8421504    ' Cinza Médio Fallback

' Cores das Marcas (Apenas para Badges)
Private Const CLR_BRAND_KHS As Long = 9863790    ' Clearline
Private Const CLR_BRAND_SIE As Long = 12411904   ' Siemens
Private Const CLR_BRAND_ROC As Long = 46116      ' Rockwell

' --- DADOS ---
Public Type T_IHM_Card
    ID As Long
    Fabricante As String
    Modelo As String
    Tamanho As String
    Engine As String
    ImgPath As String
End Type

Private Catalog() As T_IHM_Card
Private CatalogCount As Integer
Private IsCatalogLoaded As Boolean

' --- FILTROS ---
Public Filter_Clearline As Boolean
Public Filter_Siemens As Boolean
Public Filter_Rockwell As Boolean

' ==============================================================================
' 1. MAIN SETUP
' ==============================================================================
Public Sub Init_UI()
    Dim ws As Worksheet
    Set ws = ActiveSheet
    
    Application.ScreenUpdating = False
    
    ' Carrega Dados
    Load_Catalog_From_DB
    
    ' Limpeza Geral (Shapes)
    ws.DrawingObjects.Delete
    
    ' Reset de Células
    With ws.Cells
        .Interior.Color = xlNone
        .ClearContents ' Cuidado: Limpa tudo! Use com cautela se tiver dados na planilha
        .Borders.LineStyle = xlNone
    End With
    ws.Rows.RowHeight = 15
    
    ' --- CONFIGURAÇÃO DE COLUNAS ---
    ws.Columns(COL_SIDEBAR).ColumnWidth = 25 ' A
    ws.Columns("B").ColumnWidth = 2          ' Gutter
    ws.Columns("C:E").ColumnWidth = 22       ' Galeria
    ws.Columns("F").ColumnWidth = 2          ' Gutter
    ws.Columns("G:H").ColumnWidth = 15       ' Zona B (Hardware)
    ws.Columns("I").ColumnWidth = 2          ' Gutter Interno
    ws.Columns("J:L").ColumnWidth = 15       ' Zona B (Docs)
    ws.Columns("M:P").ColumnWidth = 15       ' Zona C
    
    ' --- PINTURA DO LAYOUT ---
    
    ' 1. Sidebar Fundo (A5 até o fim)
    ws.Range(ws.Cells(5, 1), ws.Cells(ws.Rows.Count, 1)).Interior.Color = CLR_SIDEBAR_BG
    
    ' 2. Cabeçalho Unificado (A4:P4) - THE COMMAND BAR
    With ws.Range("A4:P4")
        .Interior.Color = CLR_HEADER_BG
        .Font.Color = CLR_TEXT_WHITE
        .Font.Bold = True
        .Font.Name = "Segoe UI"
        .Font.Size = 9
        .VerticalAlignment = xlCenter
    End With
    
    ' Textos do Cabeçalho (Nas células)
    ws.Cells(4, 1).Value = "FILTROS"
    ws.Cells(4, 1).HorizontalAlignment = xlCenter
    
    ws.Cells(4, 2).Value = "CATÁLOGO DE MODELOS"
    ws.Cells(4, 2).HorizontalAlignment = xlLeft ' B4 é estreita, mas o texto vaza para C, D, E
    
    ws.Cells(4, 7).Value = "DETALHES DO MODELO" ' G4
    ws.Cells(4, 10).Value = "ESTRUTURA DO MANUAL" ' J4
    
    ' Filtros Default
    If Not Filter_Clearline And Not Filter_Siemens And Not Filter_Rockwell Then
        Filter_Clearline = True: Filter_Siemens = True: Filter_Rockwell = True
    End If
    
    Render_Sidebar
    Render_Gallery_Matrix
    
    ws.Range("A1").Select
    Application.ScreenUpdating = True
End Sub

' ==============================================================================
' 2. DATA LOADER
' ==============================================================================
Private Sub Load_Catalog_From_DB()
    Dim wsDB As Worksheet, lastRow As Long, i As Long
    On Error Resume Next
    Set wsDB = ThisWorkbook.Sheets("ihm_models") ' Nome da aba de dados
    If wsDB Is Nothing Then Set wsDB = ThisWorkbook.Sheets("DB_Models") ' Fallback
    On Error GoTo 0
    
    If wsDB Is Nothing Then
        ' MOCKUP DATA se não achar planilha
        CatalogCount = 3
        ReDim Catalog(1 To 3)
        Catalog(1).ID = 1: Catalog(1).Fabricante = "Clearline": Catalog(1).Modelo = "CL 3.0"
        Catalog(2).ID = 2: Catalog(2).Fabricante = "Siemens": Catalog(2).Modelo = "TP Comfort"
        Catalog(3).ID = 3: Catalog(3).Fabricante = "Rockwell": Catalog(3).Modelo = "PV Plus"
        IsCatalogLoaded = True
        Exit Sub
    End If
    
    lastRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row
    If lastRow < 2 Then Exit Sub
    
    CatalogCount = lastRow - 1
    ReDim Catalog(1 To CatalogCount)
    
    For i = 2 To lastRow
        With Catalog(i - 1)
            .ID = wsDB.Cells(i, 1).Value
            .Fabricante = wsDB.Cells(i, 3).Value
            .Modelo = wsDB.Cells(i, 4).Value
            .Tamanho = wsDB.Cells(i, 5).Value
            .Engine = wsDB.Cells(i, 6).Value
            .ImgPath = wsDB.Cells(i, 8).Value
        End With
    Next i
    IsCatalogLoaded = True
End Sub

' ==============================================================================
' 3. SIDEBAR RENDERER (CLEAN & FLAT)
' ==============================================================================
Private Sub Render_Sidebar()
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim currRow As Integer
    Dim s As Shape
    
    ' --- LIMPEZA DE FANTASMAS ---
    ' Deleta qualquer botão antigo antes de criar novos
    For Each s In ws.Shapes
        If s.Name Like "btn_filter_*" Then s.Delete
    Next s
    
    currRow = ROW_START_UI
    
    ' Desenha Botões Novos
    Draw_Flat_Btn "btn_filter_khs", "CLEARLINE", currRow, Filter_Clearline
    currRow = currRow + BTN_HEIGHT_CELLS
    
    Draw_Flat_Btn "btn_filter_sie", "SIEMENS", currRow, Filter_Siemens
    currRow = currRow + BTN_HEIGHT_CELLS
    
    Draw_Flat_Btn "btn_filter_roc", "ROCKWELL", currRow, Filter_Rockwell
End Sub

Private Sub Draw_Flat_Btn(id As String, label As String, startRow As Integer, isOn As Boolean)
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim rng As Range, btn As Shape
    
    Set rng = ws.Range(ws.Cells(startRow, 1), ws.Cells(startRow + BTN_HEIGHT_CELLS - 1, 1))
    
    Set btn = ws.Shapes.AddShape(msoShapeRoundedRectangle, _
        rng.Left + BTN_MARGIN_H, rng.Top + 2, rng.Width - (BTN_MARGIN_H * 2), rng.Height - 4)
        
    With btn
        .Name = id
        .TextFrame.Characters.Text = label
        .TextFrame.Characters.Font.Bold = True: .TextFrame.Characters.Font.Size = 9
        .TextFrame.Characters.Font.Name = "Segoe UI"
        .Line.Visible = msoFalse: .OnAction = "Toggle_Filter_Handler"
        
        ' --- FLAT STYLE ENFORCEMENT ---
        .ThreeD.BevelTopType = msoBevelNone    ' Mata o Bisel
        .ThreeD.BevelBottomType = msoBevelNone
        .Shadow.Visible = msoFalse             ' Começa sem sombra
        
        With .Fill
            .Solid                             ' Mata o Degradê
            .Transparency = 0
            If isOn Then
                .ForeColor.RGB = CLR_BTN_ACTIVE  ' Cinza Escuro
            Else
                .ForeColor.RGB = CLR_BTN_INACTIVE ' Cinza Claro
            End If
        End With
        
        If isOn Then
            .TextFrame.Characters.Font.Color = CLR_TEXT_WHITE
            ' Sombra manual sutil apenas se ativo
            .Shadow.Type = msoShadow25
            .Shadow.Blur = 3
            .Shadow.Transparency = 0.7
            .Shadow.Visible = msoTrue
        Else
            .TextFrame.Characters.Font.Color = CLR_TEXT_DARK
        End If
    End With
End Sub

' ==============================================================================
' 4. GALLERY RENDERER (CLEAN MATRIX)
' ==============================================================================
Public Sub Render_Gallery_Matrix()
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim i As Integer, counter As Integer
    Dim targetCol As Integer, targetRow As Integer, showItem As Boolean
    
    If Not IsCatalogLoaded Then Load_Catalog_From_DB
    
    ' Limpa Galeria (Deleta grupos antigos)
    Dim s As Shape
    For Each s In ws.Shapes
        If s.Name Like "grp_card_*" Then s.Delete
    Next s
    
    counter = 0
    targetRow = ROW_START_UI
    
    For i = 1 To CatalogCount
        showItem = False
        Select Case UCase(Catalog(i).Fabricante)
            Case "CLEARLINE": If Filter_Clearline Then showItem = True
            Case "SIEMENS":   If Filter_Siemens Then showItem = True
            Case "ROCKWELL":  If Filter_Rockwell Then showItem = True
        End Select
        
        If showItem Then
            targetCol = 3 + (counter Mod 3) ' C=3, D=4, E=5
            If counter > 0 And (counter Mod 3) = 0 Then targetRow = targetRow + CARD_HEIGHT_CELLS
            
            Draw_Card_Matrix Catalog(i), targetRow, targetCol
            counter = counter + 1
        End If
    Next i
End Sub

Private Sub Draw_Card_Matrix(data As T_IHM_Card, rowIdx As Integer, colIdx As Integer)
    Dim ws As Worksheet: Set ws = ActiveSheet
    Dim rng As Range, bg As Shape, img As Shape, txt As Shape
    Dim shpNames() As String: Dim shpCount As Integer: shpCount = 0
    Dim margin As Double: margin = 4
    
    Set rng = ws.Range(ws.Cells(rowIdx, colIdx), ws.Cells(rowIdx + CARD_HEIGHT_CELLS - 1, colIdx))
    
    ' 1. Fundo Flat
    Set bg = ws.Shapes.AddShape(msoShapeRoundedRectangle, _
        rng.Left + margin, rng.Top + margin, rng.Width - (margin * 2), rng.Height - (margin * 2))
    bg.Name = "tmp_bg_" & data.ID
    With bg.Fill
        .Solid
        .ForeColor.RGB = CLR_CARD_BG
    End With
    bg.Line.Visible = msoFalse: bg.ThreeD.BevelTopType = msoBevelNone
    bg.Shadow.Type = msoShadow25: bg.Shadow.Transparency = 0.8: bg.Shadow.Blur = 3
    AddShapeToArray bg.Name, shpNames, shpCount
    
    ' 2. Imagem (Placeholder Seguro)
    ' (Código simplificado para placeholder se não achar img)
    Set img = ws.Shapes.AddShape(msoShapeRectangle, bg.Left + 5, bg.Top + 5, 40, 40)
    img.Fill.ForeColor.RGB = vbWhite: img.Line.Visible = msoTrue: img.Line.ForeColor.RGB = RGB(200, 200, 200)
    img.Name = "tmp_img_" & data.ID
    AddShapeToArray img.Name, shpNames, shpCount
    
    ' 3. Título
    Set txt = ws.Shapes.AddTextbox(msoTextOrientationHorizontal, bg.Left + 50, bg.Top + 5, bg.Width - 55, 30)
    txt.Name = "tmp_txt_" & data.ID: txt.TextFrame.Characters.Text = data.Modelo
    txt.TextFrame.Characters.Font.Name = "Segoe UI": txt.TextFrame.Characters.Font.Bold = True
    txt.TextFrame.Characters.Font.Size = 9: txt.TextFrame.Characters.Font.Color = CLR_TEXT_DARK
    txt.Fill.Visible = msoFalse: txt.Line.Visible = msoFalse
    AddShapeToArray txt.Name, shpNames, shpCount
    
    ' 4. Badge
    Dim bColor As Long
    Select Case UCase(data.Fabricante)
        Case "SIEMENS": bColor = CLR_BRAND_SIE
        Case "CLEARLINE": bColor = CLR_BRAND_KHS
        Case "ROCKWELL": bColor = CLR_BRAND_ROC
        Case Else: bColor = CLR_TEXT_GREY
    End Select
    
    Dim b1 As Shape
    Set b1 = ws.Shapes.AddShape(msoShapeRoundedRectangle, bg.Left + 50, bg.Top + 35, 60, 15)
    b1.Name = "tmp_b1_" & data.ID: b1.Fill.Solid: b1.Fill.ForeColor.RGB = bColor: b1.Line.Visible = msoFalse
    b1.TextFrame.Characters.Text = data.Engine: b1.TextFrame.Characters.Font.Size = 7
    b1.TextFrame.Characters.Font.Color = vbWhite
    AddShapeToArray b1.Name, shpNames, shpCount
    
    ' 5. Agrupar
    Dim grp As Shape
    Set grp = ws.Shapes.Range(shpNames).Group
    grp.Name = "grp_card_" & data.ID
    grp.OnAction = "Card_Click_Handler"
End Sub

' ==============================================================================
' 5. HANDLERS E ZONAS FUTURAS
' ==============================================================================
Public Sub Toggle_Filter_Handler()
    Dim id As String: id = Application.Caller
    
    Application.ScreenUpdating = False ' Evita piscar feio
    
    If id = "btn_filter_khs" Then Filter_Clearline = Not Filter_Clearline
    If id = "btn_filter_sie" Then Filter_Siemens = Not Filter_Siemens
    If id = "btn_filter_roc" Then Filter_Rockwell = Not Filter_Rockwell
    
    Render_Sidebar         ' Recria os botões (apaga velhos, cria novos com cor certa)
    Render_Gallery_Matrix  ' Atualiza a galeria
    
    Application.ScreenUpdating = True
End Sub

Public Sub Card_Click_Handler()
    Dim cardID As String
    cardID = Replace(Application.Caller, "grp_card_", "")
    
    MsgBox "IHM Selecionada: " & cardID, vbInformation, "Zona A OK"
    
    ' Futuro:
    ' Render_ZoneB CLng(cardID)
    ' Render_ZoneC_Reset
End Sub

Public Sub Render_ZoneB(ihmID As Long)
    ' TODO: Implementar conforme Doc 1.3
    ' 1. Limpar G:L
    ' 2. Carregar Imagem Grande em G:H
    ' 3. Listar Capítulos em J:L com Ícones do Word
End Sub

Public Sub Render_ZoneC()
    ' TODO: Implementar conforme Doc 1.4
    ' 1. Desenhar Landing Zone M:P
    ' 2. Desenhar Botão Ignite
End Sub

' --- HELPERS ---
Private Sub AddShapeToArray(name As String, arr() As String, ByRef count As Integer)
    count = count + 1: ReDim Preserve arr(1 To count): arr(count) = name
End Sub
```
