```VBA
Option Explicit

' ==========================================================================================
' MÓDULO: mod_NewEngine_V5 (Ponte Geográfica - Versão Estendida Capa)
' DESCRIÇÃO: Ponte entre Botões do Excel e Motor C# V2 + Metadados da Capa
' FUNCIONAMENTO: Recebe o tipo da máquina, coleta metadados do Form Info, gera manifesto e chama o EXE.
' AUTOR: Mestre em VBA (via Gemini CLI)
' LOCAL: NewGeradorV2
' ==========================================================================================

Private Const TARGET_SHEET_NAME As String = "Base de Dados"
Private Const COL_PATH As String = "C"
Private Const COL_ACTIVE As String = "B"
Private Const START_ROW As Integer = 5

' --- PONTOS DE ENTRADA PARA OS BOTÕES ---
' Associe cada botão do Excel a uma destas Subs específicas

Sub Gerar_BTR()
    Call ExportarParaNovoGerador("BTR")
End Sub

Sub Gerar_GTR()
    Call ExportarParaNovoGerador("GTR")
End Sub

Sub Gerar_DVD()
    Call ExportarParaNovoGerador("DVD")
End Sub

Sub Gerar_PET()
    Call ExportarParaNovoGerador("PET")
End Sub

Sub Gerar_CIP()
    Call ExportarParaNovoGerador("CIP")
End Sub

Sub Gerar_CMX()
    Call ExportarParaNovoGerador("CMX")
End Sub

Sub Gerar_CCMX()
    Call ExportarParaNovoGerador("CCMX")
End Sub

Sub Gerar_PLT()
    Call ExportarParaNovoGerador("PLT")
End Sub

Sub Gerar_PCK()
    Call ExportarParaNovoGerador("PCK")
End Sub

' --- MOTOR PRINCIPAL ---

Private Sub ExportarParaNovoGerador(machineType As String)
    Dim ws As Worksheet
    Dim lastRow As Long, i As Long
    Dim csvContent As String
    Dim fPath As String, fActive As String
    Dim csvPath As String, exePath As String
    Dim totalFiles As Integer
    Dim fso As Object
    
    ' Variáveis para Captura de Dados da Capa
    Dim valSapNr As String
    Dim valProjeto As String
    Dim valRevisao As String
    Dim valAno As String
    
    On Error GoTo ErrorHandler
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Validação de Ambiente
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets(TARGET_SHEET_NAME)
    If ws Is Nothing Then
        Set ws = ThisWorkbook.Sheets("Dados Salvos") ' Fallback
    End If
    On Error GoTo ErrorHandler
    
    If ws Is Nothing Then
        MsgBox "ERRO: Aba 'Base de Dados' não encontrada.", vbCritical
        Exit Sub
    End If
    
    ' 2. Caminhos (Suporte a desenvolvimento e produção)
    Dim baseDir As String
    baseDir = ThisWorkbook.Path
    
    ' Procura o EXE na pasta NewGeradorV2 relativa à planilha
    If fso.FolderExists(baseDir & "\NewGeradorV2") Then
        exePath = baseDir & "\NewGeradorV2\NewGeradorV2.exe"
        csvPath = baseDir & "\NewGeradorV2\input_manifest.csv"
    Else
        ' Fallback: Se a planilha já estiver dentro de NewGeradorV2
        exePath = baseDir & "\NewGeradorV2.exe"
        csvPath = baseDir & "\input_manifest.csv"
    End If
    
    If Not fso.FileExists(exePath) Then
        MsgBox "ERRO CRÍTICO: Motor 'NewGeradorV2.exe' não encontrado em:" & vbCrLf & exePath, vbCritical
        Exit Sub
    End If
    
    ' 3. Construção do Manifesto
    ' IMPORTANTE: Enviamos TUDO que está marcado com YES.
    ' O filtro inteligente acontecerá no C# baseado no MACHINE_TYPE enviado aqui.
    
    csvContent = "CATEGORY;KEY;VALUE" & vbCrLf
    csvContent = csvContent & "META;EXPORT_DATE;" & format(Now, "yyyy-mm-dd hh:mm:ss") & vbCrLf
    csvContent = csvContent & "META;MACHINE_TYPE;" & machineType & vbCrLf
    
    ' --- [INÍCIO] INJEÇÃO DE DADOS DA CAPA (LEGADO) ---
    ' Tentativa segura de ler do UserForm 'Info' sem quebrar o código se ele não existir
    On Error Resume Next
    
    ' Valores padrão caso falhe
    valSapNr = "N/A"
    valProjeto = "N/A"
    valRevisao = "0"
    valAno = Year(Now)
    
    ' Extração (Assume que o objeto 'Info' existe no projeto VBA)
    ' Se 'Info' não estiver carregado, o VBA pode instanciar um novo vazio ou gerar erro (capturado pelo Resume Next)
    If Not Info Is Nothing Then
        valSapNr = Info.SapNr.Value
        valProjeto = Info.Projeto.Value
        valRevisao = Info.Revisao.Value
        valAno = Info.Ano.Value
    End If
    
    ' Adiciona ao CSV com chaves padronizadas para o C# ler
    csvContent = csvContent & "META;SAP_NUMBER;" & valSapNr & vbCrLf
    csvContent = csvContent & "META;ORDER_NUMBER;" & valProjeto & vbCrLf
    csvContent = csvContent & "META;REVISION;" & valRevisao & vbCrLf
    csvContent = csvContent & "META;YEAR;" & valAno & vbCrLf
    
    On Error GoTo ErrorHandler
    ' --- [FIM] INJEÇÃO DE DADOS DA CAPA ---
    
    lastRow = ws.Cells(ws.Rows.Count, COL_PATH).End(xlUp).Row
    If lastRow < START_ROW Then lastRow = START_ROW
    
    totalFiles = 0
    
    For i = START_ROW To lastRow
        fPath = Trim(ws.Range(COL_PATH & i).Value)
        fActive = UCase(Trim(ws.Range(COL_ACTIVE & i).Value))
        
        ' Enviamos o índice da linha (ROW_INDEX) para ajudar o C# a filtrar geograficamente
        If (fActive = "YES" Or fActive = "TRUE" Or fActive = "SIM" Or fActive = "X" Or fActive = "1") And fPath <> "" Then
            ' Formato: FILE;ROW_INDEX;Caminho
            ' Usamos ROW_INDEX como chave secundária para permitir o filtro geográfico
            csvContent = csvContent & "FILE;" & i & ";" & Replace(fPath, ";", "_") & vbCrLf
            totalFiles = totalFiles + 1
        End If
    Next i
    
    If totalFiles = 0 Then
        MsgBox "Aviso: Nenhum arquivo marcado com 'YES' encontrado na planilha.", vbExclamation
        Exit Sub
    End If
    
    ' 4. Salvar e Disparar
    Call SaveTextToFile(csvContent, csvPath)
    
    Dim cmd As String
    cmd = """" & exePath & """ """ & csvPath & """"
    
    ' Executa sem travar o Excel
    Shell cmd, vbNormalFocus
    
    Exit Sub

ErrorHandler:
    MsgBox "Erro inesperado: " & Err.Description, vbCritical
End Sub

Private Sub SaveTextToFile(content As String, filePath As String)
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    With stream
        .Type = 2: .Charset = "utf-8": .Open
        .WriteText content
        .SaveToFile filePath, 2
        .Close
    End With
End Sub
```