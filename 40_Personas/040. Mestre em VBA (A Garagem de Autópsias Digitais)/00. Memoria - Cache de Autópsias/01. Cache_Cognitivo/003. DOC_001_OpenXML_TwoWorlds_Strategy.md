# Protocolo OpenXML: Estratégia "Two Worlds" & Safe XML

**Status:** Descoberta Crítica
**Data:** 21/01/2026
**Contexto:** Fusão de múltiplos .docx (AltChunk) onde o 1º arquivo (Capa) tem layout customizado e o resto deve seguir um padrão (manual.dotm).

## O Problema (Amnésia de Layout & Rejeição de Órgãos)
1.  **Layout Reset:** Ao juntar arquivos, o Word tende a homogeneizar as margens, estragando a capa.
2.  **Crash Crítico:** Tentar clonar `SectionProperties` de um arquivo fechado (`manual.dotm`) para um aberto causa erro `Cannot set the given root element...` devido a vínculos persistentes de contexto no objeto C#.

## A Solução (V2.2 - Stable)

### 1. Estratégia "Two Worlds" (Isolamento de Seção)
Para manter a capa intacta e o resto padronizado, criamos dois "vagões" conceituais:
*   **Mundo 1 (Capa):** Isolado imediatamente após sua inserção com uma `SectionBreak (NextPage)`.
    *   *Tática:* Não tentamos manipular as propriedades da capa. Deixamos ela entrar como está e inserimos a barreira logo depois.
*   **Mundo 2 (Corpo):** Todos os arquivos subsequentes são separados apenas por `PageBreak`. Eles compartilham a mesma seção final.

### 2. Técnica "Safe XML" (A Cura do Crash)
O OpenXML SDK falha ao transplantar objetos complexos entre documentos.
*   **Erro:** `manualLayout = obj.CloneNode(true)` -> Leva lixo de memória junto.
*   **Correção:** Extrair o DNA como Texto Puro.
    ```csharp
    // Leitura (Origem)
    string xmlDNA = sectionProps.OuterXml; // <--- Guarda STRING, não Objeto
    
    // Escrita (Destino)
    var newProps = new SectionProperties(xmlDNA); // <--- Renasce limpo
    ```
    Isso desacopla totalmente os arquivos e evita o erro de "Part Ownership".

### 3. Update Fields (O Mal Necessário)
Para atualizar o Sumário automaticamente:
```csharp
settings.Append(new UpdateFieldsOnOpen() { Val = true });
```
*   **Efeito Colateral:** O Word exibirá um aviso "Este documento contém campos..." ao abrir.
*   **Veredito:** Aceitável. É o preço da automação.

## Snippet Essencial (C#)
```csharp
// Isolamento da Capa
if (i == 1) {
    separator = new Paragraph(new ParagraphProperties(
        new SectionProperties(new SectionType() { Val = SectionMarkValues.NextPage })
    ));
}

// Aplicação do Manual (Final do Documento)
if (!string.IsNullOrEmpty(manualLayoutXml)) {
    body.AppendChild(new SectionProperties(manualLayoutXml));
}
```
